<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break-Even Simulator | 電商營運損益模擬器</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD Development Version for better error logging, change to production in real deploy) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 字型優化 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        // 取得 React Hook 與功能
        const { useState, useEffect, useMemo, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- 內建圖示組件 (SVG Icons) ---
        // 為了確保單一檔案可攜性，將 Lucide Icons 直接轉為 SVG 組件
        const IconBase = ({ children, className }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {children}
            </svg>
        );

        const Calculator = ({ size = 24, className }) => <IconBase className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>;
        const Settings = ({ size = 24, className }) => <IconBase className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>;
        const LayoutDashboard = ({ size = 24, className }) => <IconBase className={className}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>;
        const Package = ({ size = 24, className }) => <IconBase className={className}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconBase>;
        const Layers = ({ size = 24, className }) => <IconBase className={className}><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></IconBase>;
        const Percent = ({ size = 24, className }) => <IconBase className={className}><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></IconBase>;
        const TrendingUp = ({ size = 24, className }) => <IconBase className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></IconBase>;
        const TrendingDown = ({ size = 24, className }) => <IconBase className={className}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></IconBase>;
        const BarChart3 = ({ size = 24, className }) => <IconBase className={className}><path d="M3 3v18h18"/><path d="M18 17V9"/><path d="M13 17V5"/><path d="M8 17v-3"/></IconBase>;
        const ListFilter = ({ size = 24, className }) => <IconBase className={className}><path d="M3 6h18"/><path d="M7 12h10"/><path d="M10 18h4"/></IconBase>;
        const Clock = ({ size = 24, className }) => <IconBase className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>;

        // --- 子組件: 輸入框 ---
        const InputGroup = ({ label, name, value, onChange, prefix, suffix, step = "1", className="" }) => {
            const [localValue, setLocalValue] = useState('');
            const [isFocused, setIsFocused] = useState(false);

            useEffect(() => {
                if (!isFocused) {
                    if (value === '' || value === null || value === undefined) {
                        setLocalValue('');
                    } else {
                        setLocalValue(Number(value).toLocaleString('en-US', { maximumFractionDigits: 2 }));
                    }
                }
            }, [value, isFocused]);

            const handleFocus = () => {
                setIsFocused(true);
                const raw = String(value || '').replace(/,/g, '');
                setLocalValue(raw);
            };

            const handleChange = (e) => {
                setLocalValue(e.target.value);
            };

            const commitChange = () => {
                const rawValue = localValue.replace(/,/g, '');
                onChange({ target: { name, value: rawValue } });
                setIsFocused(false);
            };

            const handleBlur = () => {
                commitChange();
            };

            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.target.blur();
                }
            };

            return (
                <div className={`flex flex-col gap-1 ${className}`}>
                    <label className="text-[11px] font-semibold text-slate-500 truncate" title={label}>{label}</label>
                    <div className="relative flex items-center h-[34px]">
                        {prefix && (
                            <span className="absolute left-2.5 text-slate-400 text-sm font-sans flex items-center justify-center pointer-events-none">
                            {prefix}
                            </span>
                        )}
                        <input
                            type="text"
                            inputMode="decimal"
                            name={name}
                            value={localValue}
                            onChange={handleChange}
                            onFocus={handleFocus}
                            onBlur={handleBlur}
                            onKeyDown={handleKeyDown}
                            className={`w-full h-full bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono font-medium text-slate-700 focus:outline-none focus:ring-2 focus:ring-[#269981]/20 focus:border-[#269981] transition-all ${prefix ? 'pl-8' : 'pl-3'} ${suffix ? 'pr-8' : 'pr-3'}`}
                        />
                        {suffix && <span className="absolute right-2.5 text-slate-400 text-xs font-bold pointer-events-none">{suffix}</span>}
                    </div>
                </div>
            );
        };

        // --- 子組件: 瀑布圖 ---
        const WaterfallChart = ({ data }) => {
            const width = 600;
            const height = 300; 
            const padding = { top: 40, bottom: 40, left: 60, right: 20 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const gmv = data[0].value;
            const totalDeductions = data.filter(d => d.type === 'deduction').reduce((acc, curr) => acc + curr.value, 0);
            const maxVal = Math.max(gmv, totalDeductions * 1.1);
            const minVal = Math.min(0, data[data.length - 1].value);
            const totalRange = maxVal - minVal;
            
            const yScale = (val) => {
                return chartHeight - ((val - minVal) / totalRange) * chartHeight;
            };

            const zeroLineY = yScale(0);
            const barWidth = (chartWidth / data.length) * 0.7; 
            const stepWidth = chartWidth / data.length;

            let currentY = gmv;
            
            return (
                <svg viewBox={`0 0 ${width} ${height}`} className="w-full h-auto drop-shadow-sm bg-white rounded-xl">
                    <line x1={padding.left} y1={zeroLineY} x2={width - padding.right} y2={zeroLineY} stroke="#e2e8f0" strokeWidth="2" />
                    <text x={padding.left - 10} y={zeroLineY + 4} textAnchor="end" fontSize="10" fill="#94a3b8">0</text>
                    <line x1={padding.left} y1={yScale(maxVal)} x2={width - padding.right} y2={yScale(maxVal)} stroke="#f1f5f9" strokeWidth="1" strokeDasharray="4" />
                    
                    {data.map((item, index) => {
                        let barX = padding.left + index * stepWidth + (stepWidth - barWidth) / 2;
                        let barY, barH;
                        let percentage = gmv > 0 ? (item.value / gmv) * 100 : 0;

                        if (item.type === 'total') {
                            barY = yScale(item.value);
                            barH = yScale(0) - barY;
                            currentY = item.value;
                        } else if (item.type === 'deduction') {
                            const topValue = currentY;
                            const bottomValue = currentY - item.value;
                            barY = yScale(topValue);
                            barH = yScale(bottomValue) - barY;
                            currentY = bottomValue;
                        } else if (item.type === 'result') {
                            if (item.value >= 0) {
                                barY = yScale(item.value);
                                barH = yScale(0) - barY;
                            } else {
                                barY = yScale(0);
                                barH = yScale(item.value) - barY;
                            }
                        }

                        const formatCompact = (n) => new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(n);

                        return (
                            <g key={index}>
                                <rect 
                                    x={barX} 
                                    y={barY} 
                                    width={barWidth} 
                                    height={Math.max(barH, 2)}
                                    fill={item.color} 
                                    rx="4"
                                    className="hover:opacity-80 transition-opacity cursor-pointer"
                                >
                                    <title>{item.label}: {new Intl.NumberFormat('zh-TW').format(Math.round(item.value))}</title>
                                </rect>
                                {index > 0 && index < data.length - 1 && (
                                    <line x1={barX - (stepWidth - barWidth)/2 - 2} y1={barY} x2={barX} y2={barY} stroke="#cbd5e1" strokeWidth="1" strokeDasharray="2" />
                                )}
                                <text x={barX + barWidth / 2} y={height - 10} textAnchor="middle" fontSize="11" fontWeight="600" fill="#475569">{item.label}</text>
                                <text x={barX + barWidth / 2} y={barY - 6} textAnchor="middle" fontSize="10" fontWeight="bold" fill={item.type === 'deduction' ? item.color : '#334155'}>
                                    {item.type === 'deduction' ? '-' : ''}{formatCompact(item.value)}
                                </text>
                                <text x={barX + barWidth / 2} y={barY + barH/2 + 4} textAnchor="middle" fontSize="9" fill="white" style={{ display: barH > 15 ? 'block' : 'none', textShadow: '0 1px 2px rgba(0,0,0,0.3)' }}>
                                    {Math.abs(percentage).toFixed(1)}%
                                </text>
                            </g>
                        );
                    })}
                </svg>
            );
        };

        // --- 主組件 ---
        const BreakEvenSimulator = () => {
            const [activeTab, setActiveTab] = useState('input'); 

            const [inputs, setInputs] = useState({
                annualGmvTarget: 40000,
                annualOrders: 533.33,
                aov: 75,
                upt: 1.0,
                cogsRate: 10,
                shopeeFeeRate: 15,
                agencyShareRate: 10,
                annualLogisticsFee: 0,
                annualWarehouseFee: 0,
                agencyFixedFee: 1540,
                annualAdBudget: 6667, // Ad Spend
                adServiceFeeRate: 20,
                annualPromoBudget: 2000,
                promoRate: 5,
                setupFee: 500,
            });

            const [months, setMonths] = useState(12);

            const handleInputChange = (e) => {
                const { name, value } = e.target;
                
                const rawValue = typeof value === 'string' ? value.replace(/,/g, '') : value;
                const numValue = parseFloat(rawValue);
                const safeValue = isNaN(numValue) ? 0 : numValue;

                setInputs((prev) => {
                    let newInputs = { ...prev, [name]: numValue };
                    if (value === '') newInputs[name] = '';

                    const calcValue = value === '' ? 0 : safeValue;
                    const safeGmv = prev.annualGmvTarget > 0 ? prev.annualGmvTarget : 1;

                    // --- Auto-Linking Logic ---
                    if (name === 'annualGmvTarget') {
                        if (prev.aov > 0) newInputs.annualOrders = calcValue / prev.aov;
                        newInputs.annualPromoBudget = calcValue * (prev.promoRate / 100);
                        
                        const currentTotalAd = prev.annualAdBudget * (1 + prev.adServiceFeeRate / 100);
                        const currentAdRate = prev.annualGmvTarget > 0 ? currentTotalAd / prev.annualGmvTarget : 0;
                        const newTotalAd = calcValue * currentAdRate;
                        newInputs.annualAdBudget = newTotalAd / (1 + prev.adServiceFeeRate / 100);

                    } else if (name === 'annualOrders') {
                        const newGmv = calcValue * prev.aov;
                        newInputs.annualGmvTarget = newGmv;
                        newInputs.annualPromoBudget = newGmv * (prev.promoRate / 100);
                        
                        const currentTotalAd = prev.annualAdBudget * (1 + prev.adServiceFeeRate / 100);
                        const currentAdRate = prev.annualGmvTarget > 0 ? currentTotalAd / prev.annualGmvTarget : 0;
                        const newTotalAd = newGmv * currentAdRate;
                        newInputs.annualAdBudget = newTotalAd / (1 + prev.adServiceFeeRate / 100);

                    } else if (name === 'aov') {
                        if (calcValue > 0) newInputs.annualOrders = prev.annualGmvTarget / calcValue;
                    } else if (name === 'annualPromoBudget') {
                        newInputs.promoRate = (calcValue / safeGmv) * 100;
                    } else if (name === 'promoRate') {
                        newInputs.annualPromoBudget = prev.annualGmvTarget * (calcValue / 100);
                        
                    } else if (name === 'totalAdBudget') { 
                        newInputs.annualAdBudget = calcValue / (1 + prev.adServiceFeeRate / 100);
                        delete newInputs.totalAdBudget;

                    } else if (name === 'adCostRatio') { 
                        const newTotalAd = safeGmv * (calcValue / 100);
                        newInputs.annualAdBudget = newTotalAd / (1 + prev.adServiceFeeRate / 100);
                        delete newInputs.adCostRatio;
                    }

                    return newInputs;
                });
            };

            const formatCurrency = (val) => {
                return new Intl.NumberFormat('zh-TW', {
                    style: 'currency',
                    currency: 'TWD',
                    maximumFractionDigits: 0,
                }).format(val);
            };

            const formatNumber = (val) => {
                return new Intl.NumberFormat('zh-TW').format(val);
            };

            const calculatedAdData = useMemo(() => {
                const safeAdBudget = (inputs.annualAdBudget === '' || isNaN(inputs.annualAdBudget)) ? 0 : inputs.annualAdBudget;
                const safeFeeRate = inputs.adServiceFeeRate === '' ? 0 : inputs.adServiceFeeRate;
                const safeGmv = inputs.annualGmvTarget === '' ? 0 : inputs.annualGmvTarget;

                const totalAdBudget = safeAdBudget * (1 + safeFeeRate / 100);
                const adCostRatio = safeGmv > 0 ? (totalAdBudget / safeGmv) * 100 : 0;
                return { totalAdBudget, adCostRatio };
            }, [inputs.annualAdBudget, inputs.adServiceFeeRate, inputs.annualGmvTarget]);

            const results = useMemo(() => {
                const val = (v) => (v === '' || isNaN(v)) ? 0 : v;

                const annualGmvTarget = val(inputs.annualGmvTarget);
                const annualAdBudget = val(inputs.annualAdBudget);
                const annualPromoBudget = val(inputs.annualPromoBudget);
                const agencyFixedFee = val(inputs.agencyFixedFee);
                const setupFee = val(inputs.setupFee);
                
                const cogsRate = val(inputs.cogsRate);
                const shopeeFeeRate = val(inputs.shopeeFeeRate);
                const agencyShareRate = val(inputs.agencyShareRate);
                const promoRate = val(inputs.promoRate);
                const adServiceFeeRate = val(inputs.adServiceFeeRate);
                const annualLogisticsFee = val(inputs.annualLogisticsFee);
                const annualWarehouseFee = val(inputs.annualWarehouseFee);

                const monthlyGmv = annualGmvTarget / 12;
                const monthlyAdSpend = annualAdBudget / 12;
                const totalGmv = monthlyGmv * months;
                
                const totalCogs = totalGmv * (cogsRate / 100);
                const totalShopeeFee = totalGmv * (shopeeFeeRate / 100);
                const totalAgencyShare = totalGmv * (agencyShareRate / 100);
                const totalPromoFee = totalGmv * (promoRate / 100); 

                const safeGmvTarget = annualGmvTarget > 0 ? annualGmvTarget : 1; 
                const logisticsRate = annualGmvTarget > 0 ? (annualLogisticsFee / safeGmvTarget) * 100 : 0;
                const warehouseRate = annualGmvTarget > 0 ? (annualWarehouseFee / safeGmvTarget) * 100 : 0;
                
                const totalLogisticsCost = totalGmv * (logisticsRate / 100);
                const totalWarehouseCost = totalGmv * (warehouseRate / 100);

                const totalAdSpend = monthlyAdSpend * months;
                const totalAdServiceFee = totalAdSpend * (adServiceFeeRate / 100);

                const totalAgencyFixedFee = agencyFixedFee * months;
                const totalSetupFee = setupFee; 

                const totalExpenses = 
                    totalCogs + 
                    totalShopeeFee + 
                    totalAgencyShare + 
                    totalAgencyFixedFee + 
                    totalAdSpend + 
                    totalAdServiceFee + 
                    totalPromoFee + 
                    totalLogisticsCost + 
                    totalWarehouseCost +
                    totalSetupFee;

                const netProfit = totalGmv - totalExpenses;
                const profitMargin = totalGmv > 0 ? (netProfit / totalGmv) * 100 : 0;
                const roi = totalExpenses > 0 ? (netProfit / totalExpenses) * 100 : 0;
                const totalOrders = val(inputs.annualOrders) * (months / 12);

                const fixedBlock_AgencyFee = agencyFixedFee * months;
                const fixedBlock_PromoFee = (annualPromoBudget / 12) * months;
                const fixedBlock_AdTotal = (calculatedAdData.totalAdBudget / 12) * months;
                const fixedBlock_SetupFee = setupFee;
                const fixedBlock_Total = fixedBlock_AgencyFee + fixedBlock_PromoFee + fixedBlock_AdTotal + fixedBlock_SetupFee;

                const varRatio_Total = cogsRate + shopeeFeeRate + agencyShareRate + logisticsRate + warehouseRate;
                const varRatio_TotalAmount = totalGmv * (varRatio_Total / 100);

                const grpCommission = totalAgencyShare + totalAgencyFixedFee + totalShopeeFee;
                const grpCogs = totalCogs;
                const grpSgap = totalAdSpend + totalAdServiceFee + totalPromoFee + totalLogisticsCost + totalWarehouseCost + totalSetupFee;

                const breakdown = [
                    {
                        category: "Commission",
                        color: "bg-orange-500",
                        items: [
                            { label: "代營運抽成", value: totalAgencyShare },
                            { label: "代營運月費", value: totalAgencyFixedFee },
                            { label: "平台抽成", value: totalShopeeFee },
                        ]
                    },
                    {
                        category: "COGs",
                        color: "bg-slate-500",
                        items: [
                            { label: "商品成本", value: totalCogs },
                        ]
                    },
                    {
                        category: "SG & AP",
                        color: "bg-sky-400",
                        items: [
                            { label: "廣告費+服務費", value: totalAdSpend + totalAdServiceFee },
                            { label: "促銷費用", value: totalPromoFee },
                            { label: "物流倉儲", value: totalLogisticsCost + totalWarehouseCost },
                            { label: "建站費", value: totalSetupFee },
                        ]
                    }
                ];

                return {
                    totalGmv,
                    totalExpenses,
                    netProfit,
                    profitMargin,
                    roi,
                    totalOrders,
                    fixedBlock: {
                        agencyFee: fixedBlock_AgencyFee,
                        promoFee: fixedBlock_PromoFee,
                        adTotal: fixedBlock_AdTotal,
                        setupFee: fixedBlock_SetupFee,
                        total: fixedBlock_Total
                    },
                    varRatio: {
                        cogs: cogsRate,
                        shopee: shopeeFeeRate,
                        agency: agencyShareRate,
                        logistics: logisticsRate,
                        warehouse: warehouseRate,
                        total: varRatio_Total,
                        totalAmount: varRatio_TotalAmount
                    },
                    waterfall: [
                        { label: 'GMV', value: totalGmv, type: 'total', color: '#269981' },
                        { label: 'Commission', value: grpCommission, type: 'deduction', color: '#fb923c' },
                        { label: 'COGs', value: grpCogs, type: 'deduction', color: '#64748b' },
                        { label: 'SG & AP', value: grpSgap, type: 'deduction', color: '#38bdf8' },
                        { label: 'P/L', value: netProfit, type: 'result', color: netProfit >= 0 ? '#22c55e' : '#ef4444' }
                    ],
                    breakdownList: breakdown
                };
            }, [inputs, months, calculatedAdData]);

            // --- Render JSX ---
            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-32">
                <header className="bg-white border-b border-slate-200 sticky top-0 z-10">
                    <div className="max-w-7xl mx-auto px-4 py-3">
                        <div className="flex flex-col md:flex-row items-center justify-between gap-4">
                            
                            <div className="flex items-center gap-3">
                                <div className="w-9 h-9 rounded-lg bg-[#269981] flex items-center justify-center text-white shadow-lg shadow-[#269981]/20">
                                    <Calculator size={20} className="text-white" />
                                </div>
                                <div className="flex flex-col">
                                    <div className="flex items-center gap-2">
                                        <h1 className="text-lg font-bold text-slate-900 tracking-tight leading-none">Break-Even Simulator</h1>
                                        <div className="flex items-center gap-1.5 text-[10px] text-[#269981] font-bold bg-[#269981]/10 px-2 py-0.5 rounded-full">
                                            <span className="w-1.5 h-1.5 rounded-full bg-[#269981] animate-pulse"></span>
                                            Live
                                        </div>
                                    </div>
                                    <p className="text-[11px] text-slate-500 font-medium leading-none mt-1">電商營運損益分析</p>
                                </div>
                            </div>

                            <div className="flex p-1 bg-slate-100 rounded-lg">
                                <button
                                    onClick={() => setActiveTab('input')}
                                    className={`flex items-center justify-center gap-2 px-4 py-1.5 text-xs font-bold rounded-md transition-all ${
                                    activeTab === 'input' 
                                    ? 'bg-white text-[#269981] shadow-sm' 
                                    : 'text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    <Settings size={14} />
                                    參數設定
                                </button>
                                <button
                                    onClick={() => setActiveTab('analysis')}
                                    className={`flex items-center justify-center gap-2 px-4 py-1.5 text-xs font-bold rounded-md transition-all ${
                                    activeTab === 'analysis' 
                                    ? 'bg-white text-[#269981] shadow-sm' 
                                    : 'text-slate-500 hover:text-slate-700'
                                    }`}
                                >
                                    <LayoutDashboard size={14} />
                                    損益儀表板
                                </button>
                            </div>

                        </div>
                    </div>
                </header>

                <main className="max-w-7xl mx-auto px-4 py-6">
                    {activeTab === 'input' && (
                    <div className="max-w-3xl mx-auto space-y-6 animate-in fade-in duration-300">
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6">
                        <div className="space-y-6">
                            
                            <div className="space-y-4">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">商品與營收 (Product & Sales)</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <InputGroup 
                                label="年度 GMV 目標" 
                                name="annualGmvTarget" 
                                value={inputs.annualGmvTarget} 
                                onChange={handleInputChange} 
                                prefix="$"
                                />
                                <InputGroup 
                                label="年度訂單數" 
                                name="annualOrders" 
                                value={Math.round(inputs.annualOrders * 10) / 10}
                                onChange={handleInputChange}
                                step="1"
                                prefix={<Package size={12} />}
                                />
                                <InputGroup 
                                label="客單價 (AOV)" 
                                name="aov" 
                                value={inputs.aov} 
                                onChange={handleInputChange} 
                                prefix="$"
                                />
                                <InputGroup 
                                label="每單件數 (UPT)" 
                                name="upt" 
                                value={inputs.upt} 
                                onChange={handleInputChange} 
                                step="0.1"
                                />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <InputGroup 
                                label="商品成本率 (COGs)" 
                                name="cogsRate" 
                                value={inputs.cogsRate} 
                                onChange={handleInputChange} 
                                suffix="%" 
                                />
                                <div></div>
                            </div>
                            </div>

                            <div className="h-px bg-slate-100"></div>

                            <div className="space-y-4">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">平台與代營運 (Platform & Agency)</h3>
                            <div className="grid grid-cols-2 gap-4">
                                <InputGroup 
                                label="平台抽成" 
                                name="shopeeFeeRate" 
                                value={inputs.shopeeFeeRate} 
                                onChange={handleInputChange} 
                                suffix="%" 
                                />
                                <InputGroup 
                                label="建站費 (一次性)" 
                                name="setupFee" 
                                value={inputs.setupFee} 
                                onChange={handleInputChange} 
                                prefix="$"
                                />
                                <InputGroup 
                                label="代營運月費 (固定)" 
                                name="agencyFixedFee" 
                                value={inputs.agencyFixedFee} 
                                onChange={handleInputChange} 
                                prefix="$"
                                />
                                <InputGroup 
                                label="代營運抽成 (GMV %)" 
                                name="agencyShareRate" 
                                value={inputs.agencyShareRate} 
                                onChange={handleInputChange} 
                                suffix="%" 
                                />
                            </div>
                            </div>

                            <div className="h-px bg-slate-100"></div>

                            <div className="space-y-4">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider">廣告與促銷 (Advertising and Promotion)</h3>
                            <div className="grid grid-cols-2 gap-2">
                                <InputGroup 
                                label="廣告投遞額" 
                                name="annualAdBudget" 
                                value={inputs.annualAdBudget} 
                                onChange={handleInputChange} 
                                prefix="$"
                                />
                                <InputGroup 
                                label="代操費率" 
                                name="adServiceFeeRate" 
                                value={inputs.adServiceFeeRate} 
                                onChange={handleInputChange} 
                                suffix="%" 
                                />
                                <InputGroup 
                                    label="年度廣告總預算" 
                                    name="totalAdBudget" 
                                    value={calculatedAdData.totalAdBudget} 
                                    onChange={handleInputChange} 
                                    prefix="$"
                                />
                                <InputGroup 
                                    label="廣告費用率 (預算/GMV)" 
                                    name="adCostRatio" 
                                    value={calculatedAdData.adCostRatio}
                                    onChange={handleInputChange} 
                                    suffix="%" 
                                    step="0.1"
                                />
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <InputGroup 
                                label="年度促銷費用預算" 
                                name="annualPromoBudget" 
                                value={inputs.annualPromoBudget} 
                                onChange={handleInputChange} 
                                prefix="$" 
                                />
                                <InputGroup 
                                label="促銷費用率 (預算/GMV)" 
                                name="promoRate" 
                                value={inputs.promoRate} 
                                onChange={handleInputChange} 
                                suffix="%" 
                                step="0.1"
                                />
                            </div>
                            </div>

                            <div className="h-px bg-slate-100"></div>

                            <div className="space-y-4">
                            <h3 className="text-xs font-bold text-slate-400 uppercase tracking-wider flex items-center gap-1">
                                物流倉儲 (Logistics & Warehousing)
                            </h3>
                            <div className="grid grid-cols-2 gap-4">
                                <InputGroup 
                                label="年度預估物流費" 
                                name="annualLogisticsFee" 
                                value={inputs.annualLogisticsFee} 
                                onChange={handleInputChange} 
                                prefix="$"
                                />
                                <InputGroup 
                                label="年度預估倉儲費" 
                                name="annualWarehouseFee" 
                                value={inputs.annualWarehouseFee} 
                                onChange={handleInputChange} 
                                prefix="$"
                                />
                            </div>
                            </div>

                            <button 
                            onClick={() => setActiveTab('analysis')}
                            className="w-full mt-4 py-3 bg-[#269981]/10 text-[#269981] font-bold rounded-xl hover:bg-[#269981]/20 transition-colors flex items-center justify-center gap-2"
                            >
                            查看分析結果 <BarChart3 size={18} />
                            </button>

                        </div>
                        </div>
                    </div>
                    )}

                    {activeTab === 'analysis' && (
                    <div className="flex flex-col gap-6 animate-in fade-in duration-300">
                        
                        {/* Section 1: Costs (Fixed & Variable) */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {/* Fixed Costs */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
                                <div className="flex items-center gap-2 mb-4">
                                    <Layers size={18} className="text-slate-600" />
                                    <h3 className="text-sm font-bold text-slate-800">固定成本 (Fixed Costs)</h3>
                                </div>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">代營運固定月費</span>
                                        <span className="font-mono text-slate-700">{formatCurrency(results.fixedBlock.agencyFee)}</span>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">促銷費用 (預算)</span>
                                        <span className="font-mono text-slate-700">{formatCurrency(results.fixedBlock.promoFee)}</span>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">廣告總費用 (含服務費)</span>
                                        <span className="font-mono text-slate-700">{formatCurrency(results.fixedBlock.adTotal)}</span>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">建站費</span>
                                        <span className="font-mono text-slate-700">{formatCurrency(results.fixedBlock.setupFee)}</span>
                                    </div>
                                    <div className="h-px bg-slate-100 my-1"></div>
                                    <div className="flex justify-between items-center font-bold">
                                        <span className="text-slate-800 text-sm">固定總成本</span>
                                        <span className="font-mono text-slate-700">{formatCurrency(results.fixedBlock.total)}</span>
                                    </div>
                                </div>
                            </div>

                            {/* Variable Ratios */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-5">
                                <div className="flex items-center gap-2 mb-4">
                                    <Percent size={18} className="text-slate-600" />
                                    <h3 className="text-sm font-bold text-slate-800">變動成本率 (Variable Ratios)</h3>
                                </div>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">商品成本率 (COGs)</span>
                                        <span className="font-mono text-slate-700">{results.varRatio.cogs.toFixed(1)}%</span>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">平台抽成</span>
                                        <span className="font-mono text-slate-700">{results.varRatio.shopee.toFixed(1)}%</span>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">代營運抽成</span>
                                        <span className="font-mono text-slate-700">{results.varRatio.agency.toFixed(1)}%</span>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">物流費用率</span>
                                        <span className="font-mono text-slate-700">{results.varRatio.logistics.toFixed(2)}%</span>
                                    </div>
                                    <div className="flex justify-between items-center text-sm">
                                        <span className="text-slate-500">倉儲費用率</span>
                                        <span className="font-mono text-slate-700">{results.varRatio.warehouse.toFixed(2)}%</span>
                                    </div>
                                    <div className="h-px bg-slate-100 my-1"></div>
                                    <div className="flex justify-between items-center font-bold">
                                        <span className="text-slate-800 text-sm">總變動成本率</span>
                                        <span className="font-mono text-slate-700">{results.varRatio.total.toFixed(1)}%</span>
                                    </div>
                                    <div className="flex justify-between items-center text-xs text-slate-400 mt-1">
                                        <span>預估總額</span>
                                        <span className="font-mono">{formatCurrency(results.varRatio.totalAmount)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Section 2: KPI Card */}
                        <div className={`w-full rounded-2xl p-6 shadow-sm border transition-colors duration-500 ${results.netProfit >= 0 ? 'bg-[#269981]/5 border-[#269981]/20' : 'bg-red-50 border-red-100'}`}>
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div>
                                    <h3 className="text-slate-500 font-medium mb-1 flex items-center gap-2">
                                        預估損益 (Profit / Loss)
                                        {results.netProfit >= 0 ? <TrendingUp size={20} className="text-[#269981]" /> : <TrendingDown size={20} className="text-red-500" />}
                                    </h3>
                                    <div className="flex items-baseline gap-4">
                                        <div className={`text-4xl font-mono font-bold tracking-tight ${results.netProfit >= 0 ? 'text-[#269981]' : 'text-red-500'}`}>
                                            {results.netProfit >= 0 ? '+' : ''}{formatCurrency(results.netProfit)}
                                        </div>
                                        <div className="text-sm text-slate-500 font-medium px-3 py-1 bg-white/50 rounded-full border border-slate-200/50">
                                            淨利率: <span className={`font-bold ${results.profitMargin >= 0 ? 'text-[#269981]' : 'text-red-500'}`}>{results.profitMargin.toFixed(1)}%</span>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex gap-8 text-right">
                                    <div>
                                        <div className="text-xs text-slate-400 mb-1 uppercase tracking-wider font-bold">Total GMV</div>
                                        <div className="text-2xl font-mono font-bold text-slate-800">{formatCurrency(results.totalGmv)}</div>
                                    </div>
                                    <div>
                                        <div className="text-xs text-slate-400 mb-1 uppercase tracking-wider font-bold">Total Orders</div>
                                        <div className="text-2xl font-mono font-bold text-slate-800">{formatNumber(Math.floor(results.totalOrders))}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Section 3: Waterfall + Breakdown */}
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 flex flex-col gap-6">
                            
                            {/* Top: Waterfall */}
                            <div className="flex flex-col h-full">
                                <div className="flex items-center gap-2 mb-4">
                                    <BarChart3 size={20} className="text-[#269981]" />
                                    <h2 className="text-lg font-bold text-slate-800">P&L 瀑布圖</h2>
                                </div>
                                <div className="flex items-center justify-center">
                                    <WaterfallChart data={results.waterfall} />
                                </div>
                            </div>

                            {/* Bottom: Breakdown List (3 Columns) */}
                            <div className="flex flex-col h-full pt-6 border-t border-slate-100">
                                <div className="flex items-center gap-2 mb-4">
                                    <ListFilter size={20} className="text-violet-500" />
                                    <h2 className="text-lg font-bold text-slate-800">成本細項 (Cost Breakdown)</h2>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {results.breakdownList.map((category, idx) => (
                                        <div key={idx} className="space-y-3">
                                            <div className="flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-500 border-b border-slate-100 pb-1">
                                                <div className={`w-2 h-2 rounded-full ${category.color}`}></div>
                                                {category.category}
                                            </div>
                                            <div className="space-y-2">
                                                {category.items.map((item, i) => (
                                                    <div key={i} className="flex justify-between items-center text-sm group hover:bg-slate-50 p-1 rounded transition-colors">
                                                        <span className="text-slate-600 font-medium">{item.label}</span>
                                                        <div className="flex items-center justify-end gap-2">
                                                            <span className="font-mono font-medium text-slate-700">{formatCurrency(item.value)}</span>
                                                            <span className="text-xs text-slate-400 font-mono w-[3.5rem] text-right">
                                                                {results.totalGmv > 0 ? ((item.value / results.totalGmv) * 100).toFixed(1) : 0}%
                                                            </span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                                <div className="pt-4 mt-4 border-t border-slate-100">
                                    <div className="flex justify-between items-center font-bold">
                                        <span className="text-slate-800">總支出 (Total Expenses)</span>
                                        <span className="font-mono text-red-500">{formatCurrency(results.totalExpenses)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button 
                        onClick={() => setActiveTab('input')}
                        className="w-full py-4 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition-colors flex items-center justify-center gap-2"
                        >
                        <Settings size={18} /> 返回調整參數
                        </button>
                        
                    </div>
                    )}

                </main>

                <div className="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-200 p-4 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-50">
                    <div className="max-w-3xl mx-auto">
                    <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2 text-[#269981] font-bold">
                        <Clock size={20} />
                        <span>合作營運時長</span>
                        </div>
                        <div className="text-2xl font-mono font-bold text-slate-800">
                        {months} <span className="text-base font-sans text-slate-500 font-medium">個月</span>
                        </div>
                    </div>
                    
                    <input
                        type="range"
                        min="6"
                        max="36"
                        step="6"
                        value={months}
                        onChange={(e) => setMonths(parseInt(e.target.value))}
                        className="w-full h-3 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-[#269981] hover:accent-[#20806b] transition-all"
                        style={{
                        backgroundImage: `linear-gradient(to right, #269981 0%, #269981 ${(months - 6) / 30 * 100}%, #e2e8f0 ${(months - 6) / 30 * 100}%, #e2e8f0 100%)`
                        }}
                    />
                    <div className="flex justify-between mt-2 text-xs text-slate-400 font-medium px-1">
                        <span>6 個月</span>
                        <span>12 個月</span>
                        <span>18 個月</span>
                        <span>24 個月</span>
                        <span>30 個月</span>
                        <span>36 個月</span>
                    </div>
                    </div>
                </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(BreakEvenSimulator));
    </script>
</body>
</html>